<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SerieController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">iSeries</a> &gt; <a href="index.source.html" class="el_package">iseries.controller</a> &gt; <span class="el_source">SerieController.java</span></div><h1>SerieController.java</h1><pre class="source lang-java linenums">package iseries.controller;

import java.io.IOException;
import java.util.Calendar;
import java.util.Date;

import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import javax.validation.Valid;

import iseries.model.SerieDTO;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import iseries.model.Comentario;
import iseries.model.Serie;
import iseries.repository.ComentarioRepository;
import iseries.repository.SerieRepository;
import iseries.repository.TemporadaRepository;
import iseries.repository.UsuarioRepository;
import iseries.util.FileUtil;

@Controller
<span class="nc" id="L32">public class SerieController {</span>

	@Autowired private UsuarioRepository userRepo;
	
	@Autowired private SerieRepository serieRepo;
	
	@Autowired private TemporadaRepository tempRepo;
	
	@Autowired private ComentarioRepository comentRepo;
	
	@Autowired private ServletContext servletContext;
	private static final String RETORN_URL = &quot;/user/visualizar-serie&quot;;
	// Inserindo Serie
	@PostMapping(value = &quot;cadastraSerie&quot;)
	String cadastraSerie(SerieDTO seriesDTO, @RequestParam(value=&quot;imagem&quot;, required=false) MultipartFile imagem,
						 BindingResult result, Model model, RedirectAttributes redirectAttributes) throws IOException{

<span class="nc" id="L49">		Serie serie = new Serie(seriesDTO);</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">		if(result.hasErrors()){</span>
<span class="nc" id="L51">			redirectAttributes.addFlashAttribute(&quot;msgErro&quot;, &quot;Erro ao Cadastrar Serie&quot;);</span>
<span class="nc" id="L52">			return &quot;redirect:homeUsuario&quot;;</span>
		}
		
<span class="nc bnc" id="L55" title="All 2 branches missed.">		if(imagem.getBytes().length != 0){</span>
<span class="nc" id="L56">			FileUtil.salvarImagem(servletContext.getRealPath(&quot;/&quot;)+&quot;resources/img/noticias/&quot;+serie.getNome()+&quot;.png&quot;, imagem);</span>
<span class="nc" id="L57">			serie.setPath(serie.getNome()+&quot;.png&quot;);</span>
		}else{
<span class="nc" id="L59">			serie.setPath(&quot;news.png&quot;);</span>
		}
		
<span class="nc" id="L62">		redirectAttributes.addFlashAttribute(&quot;msgOK&quot;, &quot;Serie Cadastrada com Sucesso&quot;);</span>
<span class="nc" id="L63">		serieRepo.save(serie);</span>
<span class="nc" id="L64">		return &quot;redirect:homeUsuario&quot;;</span>
	}
	
	// Atualizando Serie
	@PostMapping(value = &quot;updateSerie&quot;)
	String updateSerie(SerieDTO seriesDTO, Model model, @RequestParam(value=&quot;imagem&quot;, required=false) MultipartFile imagem,
			BindingResult result, RedirectAttributes redirectAttributes) throws IOException{
<span class="nc" id="L71">		Serie serie = new Serie(seriesDTO);</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">		if(result.hasErrors()){</span>
<span class="nc" id="L73">			serie = serieRepo.findOne(serie.getId());</span>
<span class="nc" id="L74">			model.addAttribute(&quot;Updateserie&quot;, serie);</span>
<span class="nc" id="L75">			redirectAttributes.addFlashAttribute(&quot;msgErro&quot;, &quot;Erro ao Atualizar Serie&quot;);</span>
<span class="nc" id="L76">			return RETORN_URL;</span>
		}
		
<span class="nc bnc" id="L79" title="All 2 branches missed.">		if(imagem.getBytes().length != 0){</span>
<span class="nc" id="L80">			FileUtil.salvarImagem(servletContext.getRealPath(&quot;/&quot;)+&quot;resources/img/noticias/&quot;+serie.getNome()+&quot;.png&quot;, imagem);</span>
<span class="nc" id="L81">			serie.setPath(serie.getNome()+&quot;.png&quot;);</span>
		}else{
<span class="nc" id="L83">			serie.setPath(&quot;news.png&quot;);</span>
		}
		
<span class="nc" id="L86">		redirectAttributes.addFlashAttribute(&quot;msgOk&quot;, &quot;Serie atualizada com Sucesso&quot;);</span>
		
<span class="nc" id="L88">		serieRepo.save(serie);</span>
		
<span class="nc" id="L90">		model.addAttribute(&quot;Serie&quot;, this.serieRepo.getOne(serie.getId()));</span>
<span class="nc" id="L91">		model.addAttribute(&quot;temporada&quot;, this.tempRepo.findTemporadaOfSerie(serie.getId()) );</span>
		
<span class="nc" id="L93">		return RETORN_URL;</span>
	}
	
	// Visualizando Serie
	@GetMapping(value = &quot;viewSerie&quot;)
	String viewSerie(HttpSession session, SerieDTO serieDTO, Model model){
<span class="nc" id="L99">		Serie serie = new Serie(serieDTO);</span>
<span class="nc" id="L100">		model.addAttribute(&quot;serieOne&quot;, this.serieRepo.getOne(serie.getId()));</span>
<span class="nc" id="L101">		model.addAttribute(&quot;temporadas&quot;, this.tempRepo.findTemporadaOfSerie(serie.getId()) );</span>
		
<span class="nc" id="L103">		return RETORN_URL;</span>
	}
	
	//Usando p/ Quando add/del Temporada...
	@GetMapping(value = &quot;viewSerieII&quot;)
	String viewSerieII(HttpSession session, Model model, @RequestParam(value=&quot;id&quot;, required=false) Integer id){
		
<span class="nc bnc" id="L110" title="All 2 branches missed.">		if(session.getAttribute(&quot;idx&quot;) != null){</span>
<span class="nc" id="L111">			id = (Integer) session.getAttribute(&quot;idx&quot;);</span>
<span class="nc" id="L112">			session.setAttribute(&quot;idx&quot;, null);</span>
		}
		
<span class="nc" id="L115">		model.addAttribute(&quot;ViewSerie&quot;, this.serieRepo.getOne(id));</span>
<span class="nc" id="L116">		model.addAttribute(&quot;temporadas&quot;, this.tempRepo.findTemporadaOfSerie(id) );</span>
		
<span class="nc" id="L118">		return RETORN_URL;</span>
	}

	//Adicionando Comentario
	@SuppressWarnings(&quot;deprecation&quot;)
	@RequestMapping(&quot;/adicionarComentario&quot;)
	@ResponseBody
	public String adicionarComentario(HttpServletRequest request, HttpServletResponse response){
		
<span class="nc" id="L127">		Date date = new Date();</span>
<span class="nc" id="L128">		Calendar calendar = Calendar.getInstance();</span>
<span class="nc" id="L129">		calendar.set(date.getYear(), date.getMonth(), date.getDate());</span>
		
<span class="nc" id="L131">		Comentario comentario = new Comentario();</span>
		// Montando Coment√°rio
<span class="nc" id="L133">		comentario.setId_usuario(Integer.parseInt(request.getParameter(&quot;user&quot;)));</span>
<span class="nc" id="L134">		comentario.setId_serie(Integer.parseInt(request.getParameter(&quot;serie&quot;)));</span>
<span class="nc" id="L135">		comentario.setTexto(request.getParameter(&quot;texto&quot;));</span>
		// Relacionando
<span class="nc" id="L137">		comentario.setUsuario(this.userRepo.findOne(Integer.parseInt(request.getParameter(&quot;user&quot;))));</span>
<span class="nc" id="L138">		comentario.setSerie(this.serieRepo.findOne(Integer.parseInt(request.getParameter(&quot;serie&quot;))));</span>
		// Registrando a Data/Hora
<span class="nc" id="L140">		comentario.setData(calendar);</span>
		
<span class="nc bnc" id="L142" title="All 2 branches missed.">		if(this.comentRepo.save(comentario) != null){</span>
<span class="nc" id="L143">		return &quot;{&quot;+</span>
<span class="nc" id="L144">					&quot;\&quot;autor\&quot;:\&quot;&quot;+comentario.getUsuario().getLogin()+&quot;\&quot;,&quot;+</span>
<span class="nc" id="L145">					&quot;\&quot;noticia\&quot;:\&quot;&quot;+comentario.getId_serie()+&quot;\&quot;,&quot;+</span>
<span class="nc" id="L146">					&quot;\&quot;texto\&quot;:\&quot;&quot;+comentario.getTexto()+&quot;\&quot;,&quot;+</span>
<span class="nc" id="L147">					&quot;\&quot;data\&quot;:&quot;+date.getTime()+&quot;}&quot;;</span>
		}
<span class="nc" id="L149">		return &quot;&quot;;</span>
	}
	
	//Removendo Comentario
	@GetMapping(value = &quot;deletarComentario&quot;)
	String removerComentario(Comentario comentario, HttpSession session){
<span class="nc" id="L155">		comentario = this.comentRepo.findOne(comentario.getId());</span>
<span class="nc" id="L156">		this.comentRepo.delete(comentario);</span>
<span class="nc" id="L157">		session.setAttribute(&quot;idx&quot;, comentario.getId_serie());</span>
<span class="nc" id="L158">		return &quot;redirect:viewSerieII&quot;;</span>
	}

}














</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>